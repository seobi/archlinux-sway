define("HubsExtension/Store/Common",["require","exports"],(function(){"use strict";var n;return (function(n){var t,i,r;(function(n){n.CreateHub="CreateHub"})(t=n.Source||(n.Source={})),(function(n){n.CreateDeploymentEnd="CreateDeploymentEnd";n.CreateDeploymentPreflight="CreateDeploymentPreflight";n.CreateDeploymentStart="CreateDeploymentStart"})(i=n.Action||(n.Action={})),(function(n){n.Canceled="Canceled";n.Default="Default";n.Failed="Failed";n.Succeeded="Succeeded";n.UnknownError="UnknownError"})(r=n.ActionModifier||(n.ActionModifier={}))})(n||(n={})),n}));define("HubsExtension/Store/DeploymentManagerV2",["require","exports","f","i","o","a","ko","FxHubs/CloudNameCommon","FxHubs/HubsSettingsSchema","FxHubs/RpcEndPoints","HubsExtension/HubsCommon","HubsExtension/Store/StoreClientStrings","moment","HubsExtension/ArmHelpers/ArmApis","HubsExtension/ArmHelpers/ArmApisStartup","HubsExtension/Common/HubsObservables","HubsExtension/Common/HubsPermissions","HubsExtension/Common/UserSettingsHelper","HubsExtension/Notifications/EventSubscriptionService",
"HubsExtension/Store/Common"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d){"use strict";var g;return (function(t){function ht(n){return n.toLowerCase()}function it(n){return n&&typeof n=="string"}function ct(n,t){return!(n||"").localeCompareIgnoreCase(t)}function dt(n,t,i){var r=u.keys(n),o=r.some((function(n){return n===t})),f,e;return!o&&r.length&&r.length>=i&&(f=r[0],e=a(n[f]),st(n,(function(t,i){a(i).isBefore(e)&&(e=a(n[f=t]))})),delete n[f]),n[t]=a().valueOf(),n}function kt(n){return ht(n&&n.registrationState||"")}function gt(n,t){var u=Q.defer(),r=i.clone(n,!0,!0);return r.notify=function(n){return u.notify(n)},t&&(r.skipPreflight=!0,r.submitDeployment=!1,r.pollForUpdates=!0),et.startDeployment(r).then((function(n){delete n.notify;u.resolve(n)})).catch(u.reject),u.promise}function ii(n){return gt(n)}function ri(n){var r=Q.defer(),t=i.clone(n,!0,!0);return t.deploymentMode=4,t.suppressDefaultNotifications=!0,t.validateTemplate=!0,et.startDeployment(t).then(r.resolve).catch(r.reject),
r.promise}function ui(n){return gt(n,!0)}function fi(n,t,i){if(t===void 0&&(t=[]),!t.length)return Q({success:!0,failedRPs:undefined,disallowedRPs:undefined});var r=[],u=[],f=t.map((function(t){var f=v.getResourceProviderWithSubscriptionApi(n,t);return et.getArmResource(f,i,"canRegisterSubWithRPs").then((function(u){var f=kt(u);if(f!==wt)return w.hubsChecker.hasPermission(rt.buildSubscriptionIdFromSubscriptionName(n),[t+"/register/action"],null,i).then((function(n){n||r.push(t)}))}),(function(n){var i=ot.buildSimplifiedError(n.jqXHR||n);if(i.status===400&&i.code.toLowerCase()==="disallowedprovider"){u.push(t);return}throw n;}))}));return Q.allSettled(f).then((function(i){return(i||[]).forEach((function(i,r){if(i.state===bt){var u=i.reason||{};u=ot.buildSimplifiedError(u.jqXHR||u);nt.warning("Failed to check if the subscription "+n+" has permissions to register with the resource provider "+t[r]+". Continue with create. Details: "+u.message);return}})),{success:!r.length&&!u.length,failedRPs:r,disallowedRPs:
u}}))}function ei(n,t,i){return et.registerResourceProviders({subscriptionId:n,resourceProviders:t,cloudName:i})}function oi(n,t,i,r,u){var f=rt.buildResourceGroupIdFromSubscriptionAndResourceGroupName(n,t),e=y.resourceGroupApi(f);return et.createResourceGroup(e,{name:t,location:i},r,!0,u)}function si(n,i,r,u){var o=vt(ut.createLauncherLastUsedResourceGroupLocation,u),s=vt(ut.createLauncherLastUsedSubscriptionId,u),f=vt(ut.createLastDeployedItems,u),e=vt(ut.deploymentsLastUsedLocations,u);return Q.all([pt.readSettings([f,e]),p.getLocations(u)]).spread((function(u,h){var c={},v=u[f]||{},l=u[e]||{},a;return it(l)&&(l={}),r&&(dt(v,r,t.lastUsedGalleryItemsMaxCount),c[f]=v),a=h.first((function(n){return ct(n.name,i)||ct(n.displayName,i)})),a&&(dt(l,a.name,t.lastUsedLocationsMaxCount),c[o]=a.name,c[e]=l),c[s]=n,pt.writeSettings(c)}))}function hi(n,t){return pt.readSettingsRpc([ut.createLastDeployedItems,ut.createLauncherLastUsedSubscriptionId,ut.createLauncherLastUsedResourceGroupLocation],t)}var
lt=i.Base,ni=r.Rpc,yt=i.Azure.ResourceManager,ot=r.Azure,g=yt.DeploymentStages,ft=yt.DeploymentStatusCode,ut=s.Keys,tt=i.Hubs.Notifications.NotificationStatus,ti=r.Hubs.Notifications,rt=i.ViewModels.Services.ResourceTypes,pt=b.UserSettingsHelper,et;t.lastUsedGalleryItemsMaxCount=5;t.lastUsedLocationsMaxCount=5;var nt=lt.Diagnostics.createLog(n),at=o.addCloudNameToId,vt=b.addCloudNameToUserSettingKey,st=i.forEachKey,wt="registered",bt="rejected";t.deployTemplate=ii;t.validateTemplate=ri;t.pollForDeployment=ui;t.canRegisterSubWithRPs=fi;t.registerResourceProviders=ei;t.createResourceGroup=oi;t.updateUserSettings=si;t.getMarketplaceUserSettings=hi,(function(n){function b(n,t,i,r){t([((n||{}).launchingContext||{}).galleryItemId||""].concat([i,r]))}function fr(n){return ht(i.trimEnd(n,"/"))}function er(n){return(n&&n.properties||{}).error}function dt(n){return n&&(n.jqXHR&&(n=ot.buildSimplifiedError(n.jqXHR)),n.status!==0||n.code||(n.code=tu)),n}function et(n,t,i,r,u){n=n||{};var f={deploymentStatusCode:
ft.Failure,stage:i,expected:!!r,error:t,subscriptionId:n.subscriptionId,resourceGroupName:n.resourceGroupName,resourceGroupLocation:n.resourceGroupLocation,deploymentName:n.deploymentName};u&&(f.details=u);throw f;}function wi(n,t,i){var r=i&&i.jqXHR&&i.jqXHR.responseJSON&&i.jqXHR.responseJSON.error;return i=dt(i),et(n,i,t,i.status>=400&&i.status<500,r)}function or(n){return n.suppressDefaultNotifications||n._notification||(n._notification=new ti.InternalClientNotification({status:tt.InProgress,title:"",description:"",descriptionAsHtml:!0,timestamp:new Date,cloudName:n.cloudName||si.DefaultCloudName})),n}function hu(n,t){return"#resource"+at(n,t,!0)}function gt(n,t){return"#asset"+at("/"+hi+"/ResourceGroups"+n,t,!0)}function ii(n,t){return"#blade"+at("/"+hi+"/DeploymentDetailsBlade/id/"+encodeURIComponent(n),t,!0)}function sr(n,t){if(n.notify){var i=n.deployment,r=i&&i.properties||{};n.notify({deploymentStatusCode:n.deploymentStatusCode,subscriptionId:n.subscriptionId,deploymentName:n.
deploymentName,resourceGroupName:n.resourceGroupName,resourceGroupLocation:n.resourceGroupLocation,templateJson:n.templateJson,templateLinkUri:n.templateLinkUri,resourceId:n.resourceId,resourceProviders:n.resourceProviders,requestTimestamp:n.requestTimestamp,deployment:i,correlationId:r.correlationId,provisioningState:r.provisioningState,timestamp:r.timestamp,operations:t})}}function vt(n,t,i,r,u){or(n);var f=n._notification;return f?(f.status=t,f.title=i,f.description=r,f.descriptionAsHtml=!0,Q().then((function(){var i=n.deployment,h,e,r,t;i?(h=pt(i),e=i.properties.correlationId,~f.correlationIds.indexOf(e)||f.correlationIds.push(e),h===s.Succeeded?(f.uri=u,r=!rt.isResourceId(n.resourceId||""),t=(n.notifications||{}).pinToDashboard||r&&{name:c.resourceGroupPartName,extension:hi,parameters:{id:rt.buildResourceGroupIdFromDescriptor({resourceGroup:n.resourceGroupId,subscription:n.subscriptionId})}},t&&(f.inlineForm={buttons:[{label:r?o.Actions.goToResourceGroup:o.Actions.goToResource,deepLink:
{uri:r?f.uri=gt(n.resourceGroupId,n.cloudName):hu(n.resourceId,n.cloudName)}},{label:o.Actions.pinToDashboard,pinToDashboard:{name:t.name,extension:t.extension,parameters:t.parameters}}]})):f.uri=ii(i.id,n.cloudName)):u&&(f.uri=u)})).then((function(){return f.publish()}))):Q()}function cu(n){vt(n,tt.InProgress,o.InitializingDeployment.label,o.InitializingDeployment.message.format(n.resourceGroupName))}function lu(n){vt(n,tt.InProgress,o.SubmittingDeployment.label,o.SubmittingDeployment.message.format(n.resourceGroupName),gt(n.resourceGroupId,n.cloudName))}function hr(n){var t=n.deployment;vt(n,tt.InProgress,o.DeploymentInProgress.label,o.DeploymentInProgress.message.format(n.resourceGroupName),t&&ii(t.id,n.cloudName))}function au(n){var t=n.deployment,i=t&&ii(t.id,n.cloudName);vt(n,tt.Success,o.DeploymentSucceeded.label,o.DeploymentSucceeded.message.format(nr.format(i,n.deploymentName),nr.format(gt(n.resourceGroupId,n.cloudName),n.resourceGroupName)),i)}function cr(n,t){var h;t===void 0&&
(t={});var c=n.deployment,r=n.resourceGroupName,u=o.DeploymentRequestFailed.label,i=o.DeploymentRequestFailed.message.format(r),a=tt.Error,e,l,s,f=(t.error||er(c)||{}).message;switch(t.stage){case g.InitialSetup:case g.SanityCheck:case g.FulfillPrerequisites:case g.GetDeploymentName:u=o.ErrorStartingDeployment.label;i=o.ErrorStartingDeployment.message.format(r);break;case g.ProvisionResourceGroup:u=o.ErrorStartingDeployment.label;i=o.ErrorProvisioningResourceGroup.message.format(r);break;case g.RegisterResourceProviders:u=o.ErrorStartingDeployment.label;i=o.ErrorRegisteringResourceProviders.message.format(r);break;case g.ValidateTemplate:u=o.DeploymentValidationFailed.label;i=o.DeploymentValidationFailed.message.format(r);s=!(e=!!f);break;case g.SubmitDeploymentRequest:u=o.ErrorSubmittingDeploymentRequest.label;i=o.ErrorSubmittingDeploymentRequest.message.format(r);s=!(e=!!f);break;case g.GetDeploymentStatus:u=o.ErrorGettingDeploymentStatus.label;i=o.ErrorGettingDeploymentStatus.message.
format(r);a=tt.Warning;l=!(e=!!f);break;default:u=o.DeploymentFailed.label;i=o.DeploymentFailed.message.format(r);l=!(e=!!f)}return f&&(i+="<br/>"+o.additionalDetailsPrefix+" "+f),l&&(c?h=ii(c.id,n.cloudName):s=!0),s&&(h=gt(n.resourceGroupId,n.cloudName)),e&&(h="#resource"+at(n.resourceGroupId,n.cloudName,!0)+"/eventlogs"),vt(n,a,u,i,h)}function vu(n){var t=n.deployment;vt(n,tt.Information,o.DeploymentCanceled.label,o.DeploymentCanceled.message.format(n.resourceGroupName),t&&ii(t.id,n.cloudName))}function yu(n){var t=n.deployment;vt(n,tt.Information,o.DeploymentDeleted.label,o.DeploymentDeleted.message.format(n.resourceGroupName),t&&ii(t.id,n.cloudName))}function pu(n,t){var i=o.DeploymentStatusUnknown.message.format(n.resourceGroupName);t&&(i+=" "+o.additionalDetailsPrefix+" "+t);vt(n,tt.Warning,o.ErrorGettingDeploymentStatus.label,i,gt(n.resourceGroupId,n.cloudName))}function lr(n,t,i){return y.callRaw({armApiOrUri:n,httpMethod:"GET",dataType:"json",cloudName:t,telemetry:fi(i)})}function ri(
n,t,i){return lr(n,t,i).then((function(n){return n.content}))}function pt(n){var t=n&&n.properties||{};return ht(t.provisioningState||"")}function ar(t,i,r,u,f){return f===void 0&&(f=n.resourceGroupCheckRetries),Q().then((function(){var e=pt(t);switch(e){case s.Succeeded:case s.Failed:return nt.verbose("Creating resource group "+r+" "+e+"."),t;default:return f?Q.delay(n.resourceGroupCheckDelay).then((function(){return ri(i,u,""+p+ui+".attempt"+(n.resourceGroupCheckRetries-f))})).then((function(n){return ar(n,i,r,u,f-1)})):(nt.warning("Creating resource group "+r+": Status unknown after "+n.resourceGroupCheckRetries+" attempts."),t)}}))}function vr(t,i,r,u,f,e){return e===void 0&&(e=n.rpRegistrationCheckRetries),Q().then((function(){return kt(t)===wt?t:e?Q.delay(n.rpRegistrationCheckDelay).then((function(){return ri(i,f,""+p+ru+".attempt"+(n.resourceGroupCheckRetries-e))})).then((function(n){return vr(n,i,r,u,f,e-1)})):(nt.warning("Status unknown for registering sub "+r+" with RP "+u+" after "+n.rpRegistrationCheckRetries+
" attempts."),t)}))}function bi(n,t){return v.singleDeploymentApi(n+"/deployments/"+t)}function yr(n,t,i,r){r===void 0&&(r=0);var u=n;return Q().then((function(){if(r){var f="_"+r;u=n.substr(0,nu-f.length)+f}return ri(bi(t,u),i,""+p+uu)})).then((function(f){return!~tr.indexOf(pt(f))?yr(n,t,i,++r):u})).catch((function(t){return t=dt(t),nt.warning("Failed to get deployment with name "+u+". Proceeding with "+n+". "+t.message),u}))}function pr(n){var i={mode:"incremental",debugSetting:{detailLevel:"RequestContent, ResponseContent"}},r,t,u;if(it(n.parametersLinkUri)?i.parametersLink={uri:n.parametersLinkUri}:(r={},st(n.parameters||{},(function(n,t){r[n]={value:t}})),st(n.referenceParameters||{},(function(n,t){r[n]={reference:t}})),i.parameters=r),t=n.templateJson,!t)!n.templateLinkUri||(i.templateLink={uri:n.templateLinkUri});else{u=void 0;try{it(t)?(u="Invalid JSON",t=JSON.parse(t)):(u="Non-serializable object",t=e.toJS(t))}catch(f){b(n,w.parsingTemplateJson,u)}i.template=n.templateJson=t}return{properties:
i}}function wu(n){return au(n),n.deploymentStatusCode=ft.Success,t.updateUserSettings(n.subscriptionId,n.resourceGroupLocation,(n.launchingContext||{}).galleryItemId,n.cloudName),rt.isResourceId(n.resourceId)&&h.AssetTypes.signalResourcesChangedEndPoint.invoke(ni.client,si.Shell,{resourceIds:[n.resourceId],cloudName:n.cloudName}),n}function bu(n){return cr(n),n.deploymentStatusCode=ft.Failure,n}function ku(n){return vu(n),n.deploymentStatusCode=ft.Failure,n}function du(n){return yu(n),n.deploymentStatusCode=ft.Failure,n}function gu(n,t){return pu(n,t),n}function wr(n,t){return lr(n.deploymentUri,n.cloudName,t)}function nf(n){if(n.getAllOperations){var t=[],i=v.deploymentOperationsApi(n.deployment.id);return y.callWithContinuation([i],(function(n){t=t.concat(n||[])}),(function(n){throw n;}),n.cloudName,y.makeResourceManagerTelemetry(p+"getOperations")).then((function(){return t})).catch((function(n){return nt.warning("Failed to get deployment operations: "+JSON.stringify(n.jqXHR.responseJSON)),
undefined}))}return Q(undefined)}function br(n,t,i,r,u){return y.call(n,"PUT",JSON.stringify(t),i,u||fi(p+ui)).then((function(u){return r?ar(u,n,t.name,i):Q(u)}))}function tf(n,t,i,r){var u=!1,f=v.getResourceProviderWithSubscriptionApi(n,t),e=""+p+ui+".checkState";return ri(f,i,e).then((function(r){var e=kt(r),f;return(u=e===wt)?Q(r):(f=v.registerResourceProvidersApi(n,t),y.call(f,"POST",undefined,i,fi(p+ui)))})).then((function(e){return!u&&r?vr(e,f,n,t,i):Q(e)}))}function ki(n,t,i){var u=n.launchingContext||{},v=u&&u.galleryItemId,e=n.debug,r={galleryItemId:v,stage:g[t],subscriptionId:n.subscriptionId,bladeInstanceId:u.bladeInstanceId,telemetryId:n.telemetryId},o=u.source,s=u.createBlade,f=n.deployment,h=f&&f.properties,c=h&&h.correlationId,l=er(f),a=l?ot.parseArmError(l,!0):i&&ot.scrubError(i);return o&&(r.context=o),c&&(r.correlationId=c),s&&(r.createBlade=s),e&&(r.debug=e),a&&(r.details=a),n._pollingStats&&(r.pollingStats=n._pollingStats),n.deploymentMode&&n.deploymentMode!==1||(r.pollForUpdates=
!1),r}function rf(n){var t=ki(n,g.InitialSetup);return n._startPreflightTs=Date.now(),gi.startTrace({source:rr,action:eu,actionModifier:ai,name:t.galleryItemId||n.deploymentName,data:t})}function kr(n,t,i,r){t._endPreflightTs=Date.now();var u=i?g.FulfillPrerequisites:g.ValidateTemplate;gi.endTrace(n,r?oi:vi,ki(t,u,r))}function ei(n,t,i,r,u){var f=ki(n,r,u);gr.traceDeployment({source:rr,action:t,actionModifier:i,name:f.galleryItemId||n.deploymentName,data:f})}function uf(n){return n===void 0&&(n={}),Q().then((function(){var t=n.deploymentMode,f=n.launchingContext||{},r,u=n.telemetryId=n.telemetryId||f.telemetryId;return i.isUndefined(u)&&(u=n.telemetryId=i.newGuid()),i.isUndefined(r=n.skipPreflight)&&(r=n.skipPreflight=!1),i.isUndefined(n.validateTemplate)&&(n.validateTemplate=!r),i.isUndefined(n.submitDeployment)&&(n.submitDeployment=t!==4),i.isUndefined(n.getAllOperations)&&(n.getAllOperations=t===3),i.isUndefined(n.pollForUpdates)&&(n.pollForUpdates=!!~[2,3].indexOf(t)),n.deploymentStatusCode=
ft.Success,i.isUndefined(n.resourceGroupId)&&(n.resourceGroupId=rt.buildResourceGroupIdFromSubscriptionAndResourceGroupName(n.subscriptionId,n.resourceGroupName)),n._retryAfter=[],or(n)})).catch((function(t){return et(n,t,g.InitialSetup)}))}function ff(n){return Q().then((function(){var t=function(n){return(n||"").toString()},s,h,c,l,o,a,i,r,e;return n||b(n,w.optionsUndefined),s=n.subscriptionId,it(s)||b(n,w.subscriptionIdUndefined,t(s)),h=n.resourceGroupName,it(h)||b(n,w.resourceGroupNameUndefined,t(h)),c=n.resourceGroupLocation,it(c)||b(n,w.resourceGroupLocationUndefined,t(c)),l=n.deploymentName,it(l)||b(n,w.deploymentNameUndefined,t(l)),o=n.parametersLinkUri,o&&((n.parameters||n.referenceParameters)&&b(n,w.parametersLinkAndParameters),it(o)||b(n,w.uriNotAString,t(o),"parametersLinkUri")),n.parameters&&n.referenceParameters&&(a=u.keys(n.parameters).first((function(t){return u.keys(n.referenceParameters).some((function(n){return t===n}))})),a&&b(n,w.duplicateKey,a)),i=n.templateLinkUri,!i==!n.
templateJson&&b(n,w.templateLinkAndJson),i&&!it(i)&&b(n,w.uriNotAString,t(i),"templateLinkUri"),r=n.resourceId,!r||rt.isResourceId(r)||rt.isResourceGroupId(r)||b(n,w.invalidResourceId,t(r)),e=n.resourceProviders,e&&(!f.isArray(e)||e.some((function(n){return!it(n)})))&&b(n,w.invalidResourceProviders,t(e)),n})).catch((function(t){return et(n,t,g.SanityCheck,!0)}))}function ef(n){var u=n.cloudName,t=n.resourceGroupName,r;return Q().then((function(){return r=y.resourceGroupApi(n.resourceGroupId),ri(r,u,""+p+ui+".checkExistence")})).then((function(i){var r=pt(i),u;return!~iu.indexOf(r)?(nt.verbose("Resource group "+t+" already exists."),n):(u=new Error("Cannot deploy to resource group "+t+": "+r+"."),et(n,u,g.ProvisionResourceGroup,!0))})).catch((function(i){if((i&&i.jqXHR||{}).status===404)return br(r,{name:t,location:n.resourceGroupLocation},u,!0).then((function(){return nt.verbose("Resource group "+t+" created."),n}));throw i;})).catch((function(r){if(!i.isUndefined(r.stage))return Q.reject(r);r=dt(r);
var u=r.message,f=!1;return r.status===403&&(u="Unauthorized access to resource group "+t+": "+r.message,f=!0),nt.verbose(u),et(n,r,g.ProvisionResourceGroup,f)}))}function of(t){var i=t.resourceProviders||[],r=t.subscriptionId;return i.length?Q().then((function(){var u=i.map((function(i){return n.registerResourceProvider(r,i,t.cloudName,!0)}));return Q.allSettled(u)})).then((function(n){return st(n||[],(function(n,t){t.state===bt&&nt.warning("Failed to register "+i[n]+" for sub "+r+". "+dt(t.reason).message)})),t})).catch((function(n){return et(t,dt(n),g.RegisterResourceProviders)})):Q(t)}function sf(n){return Q().then((function(){return yr(n.deploymentName,n.resourceGroupId,n.cloudName)})).then((function(t){return n.deploymentName=t,n})).catch((function(t){return et(n,t,g.GetDeploymentName)}))}function hf(t){return Q().then((function(){return cu(t),Q.allSettled([n.provisionResourceGroup(t),n.registerResourceProviders(t),n.getDeploymentName(t)])})).then((function(n){var i=(n||[]).first((function(n){return n.
state===bt}));if(i)throw i.reason;return t})).catch((function(n){return i.isUndefined(n.stage)?et(t,n,g.FulfillPrerequisites):Q.reject(n)}))}function cf(n){return Q().then((function(){var t,i;return lu(n),t=n.deploymentRequest,t||(t=n.deploymentRequest=pr(n)),i=n.deploymentUri=bi(n.resourceGroupId,n.deploymentName),n.validationResult&&(t.properties.validationLevel="Template"),n._startDeploymentTs=Date.now(),y.call(i,"PUT",JSON.stringify(t),n.cloudName,fi(p+fu))})).then((function(t){var r=pt(t),i;return r!==s.Accepted?(i=new Error("Deployment not accepted."),i.details=t,et(n,i,g.SubmitDeploymentRequest)):(n.deployment=t,hr(n),n)})).catch((function(t){return i.isUndefined(t.stage)?wi(n,g.SubmitDeploymentRequest,t):Q.reject(t)}))}function di(n,t,i,r){n.deployment=t;switch(i){case s.Succeeded:return wu(n);case s.Failed:return bu(n);case s.Canceled:return ku(n);case s.Deleted:return du(n);default:return r(n)}}function lf(n){var r=n.requestTimestamp,i,u;r?(i=a(r),u=a(r).add(7,"days")):(i=a(),u=a(i).subtract(
7,"days"));var s=new lt.UriBuilder(n.deploymentUri).getRelativePath(),f=n.deployment.properties.correlationId,h="eventChannels eq 'Admin, Operation' and correlationId eq '{0}'".format(f),c=y.getEventsApi(n.subscriptionId,i,u,h),e=" for deployment "+n.deploymentName+", correlationId "+f+".",o=function(t){var i="Deployment status unavailable. correlationId didn't match. "+t;return nt.warning(i),gu(n,i),et(n,dt(new Error(i)),g.GetDeploymentStatus,!0)},t=[],l=y.callWithContinuation([c],(function(n){t=t.concat(n||[])}),(function(n){throw n;}),n.cloudName,y.makeResourceManagerTelemetry(p+"getEvents"));return l.then((function(){var i,r;return!t||!t.length?o("Failed to get status"+e):(i=t.filter((function(n){return ct(s,n.resourceUri)&&ct(pi,(n.operationName||{}).value)})),i.length<1)?o("Failed to get events"+e):(i.sort((function(n,t){return a(t.eventTimestamp).diff(a(n.eventTimestamp))})),r=i[0],di(n,{id:s,name:pi,properties:{correlationId:f,provisioningState:r.status.value,timestamp:r.eventTimestamp}},
ht(r.status.value),(function(){return o("Unexpected provisioning state"+e)})))}),(function(t){return et(n,dt(t.reason),g.GetDeploymentStatus)}))}function af(n,t){return t?t*1e3:n<=80?5e3:(n-=80,n<=60)?6e4:3e5}function dr(t,i){return t._stopPolling?Q(t):(i||(i={count:0,retryAfter:undefined}),Q().then((function(){return wr(t,""+p+ir+".attempt"+i.count)})).then((function(r){var u=r.content;return ct(u.properties.correlationId,t.deployment.properties.correlationId)?nf(t).then((function(f){return t.operations=f,di(t,u,pt(u),(function(t){sr(t,f);var u=parseInt(r.jqXHR.getResponseHeader("Retry-After"));return t._retryAfter.push(u),Q.delay(n.getPollingInterval(i.count,u)).then((function(){return i={count:i.count+1,retryAfter:u},dr(t,i)}))}))})):n.handleOverriddenDeployment(t)})).catch((function(n){return wi(t,g.GetDeploymentStatus,n)})).finally((function(){i.count<=1&&(t._pollingStats={startPreflightTs:t._startPreflightTs,endPreflightTs:t._endPreflightTs,startDeploymentTs:t._startDeploymentTs,endDeploymentTs:Date.
now(),startArm:t.requestTimestamp,endArm:t.deployment.properties.timestamp,retryAfter:t._retryAfter})})))}function vf(t){return Q(t).then((function(t){var i=Q.defer();return t.deploymentUri||(t.deploymentUri=bi(t.resourceGroupId,t.deploymentName)),t.deployment&&hr(t),t.requestTimestamp||(t.requestTimestamp=t.deployment.properties.timestamp),n.checkDeploymentStatus(t).then(i.resolve,i.reject),Q().then((function(){var n=k.subscribeToArmEvent(ou,(function(n){st(n,(function(n,r){var u,f,e;r===void 0&&(r={});u=t.deploymentUri;f=u.indexOf("?");u=fr(f>-1?u.substring(0,f):u);e=ht(r.status||"");r.correlationId!==t.deployment.properties.correlationId||u!==fr(r.assetId)||r.subStatus!==""||!~tr.indexOf(e)||i.promise.inspect().state==="pending"&&(t._stopPolling=!0,nt.verbose("Deployment "+e+" based on eventService: "+r+"."),wr(t,""+p+ir+".eventMatch").then((function(n){var u=pt(n.content);i.resolve(di(t,n.content,u,(function(){throw new Error("Deployment completed at a non-terminal state: "+u+": "+r+".");
})))})).catch(i.reject))}))}));i.promise.finally((function(){k.removeArmEventSubscription(n)}))})).catch(i.reject),i.promise}))}function yf(n){return Q().then((function(){var t=n.deploymentRequest=pr(n);return y.call(v.validateDeploymentApi(n.resourceGroupId,n.deploymentName),"POST",JSON.stringify(t),n.cloudName,fi(p+"validate"))})).then((function(t){return n.validationResult=t,n})).catch((function(t){return wi(n,g.ValidateTemplate,t)}))}function pf(t){return Q(t).then(n.sanityCheck).then(n.initialSetup).then((function(t){if(!t.skipPreflight){var i=rf(t);return n.fulfillPrerequisites(t).then((function(t){return t.validateTemplate?n.validateTemplate(t):Q(t)})).then((function(n){return i&&kr(i,n,!n.validateTemplate),n}),(function(n){i&&kr(i,t,!t.validateTemplate,n);throw n;}))}return t})).then((function(t){return t.submitDeployment?n.submitDeploymentRequest(t).then((function(n){return ei(n,ur,vi,g.SubmitDeploymentRequest),n.deploymentMode&&n.deploymentMode!==1?sr(n,null):ei(n,yi,ai,g.SubmitDeploymentRequest),n})
,(function(n){ei(t,ur,oi,n.stage,n);throw n;})):t})).then((function(t){return t.pollForUpdates?n.pollForDeployment(t).then((function(n){var t=oi;switch(pt(n.deployment)){case s.Succeeded:t=vi;break;case s.Canceled:case s.Deleted:t=ai}return ei(n,yi,t,g.GetDeploymentStatus),n}),(function(n){ei(t,yi,oi,n.stage,n);throw n;})):t})).catch((function(n){return cr(t,n).then((function(t){return n.notificationTimestamp=t,Q.reject(n)}))}))}var si=lt.Constants,gr=r.ProvisioningTelemetry,gi=lt.Diagnostics.Telemetry,o=l.Notifications.DeployTemplate,s=yt.DeploymentStates,hi=si.ExtensionNames.Hubs,nr='<a href="{0}">{1}<\/a>',nu=64,tr=[s.Succeeded,s.Failed,s.Deleted,s.Canceled],tu="ClientNetworkError",iu=[s.Deleted,s.Deleting,"movingresources"],p="Deploy.",ui="createRG",ru="registerRP",uu="getDepName",fu="submitDeployment",ir="pollForUpdates",rr=d.Source.CreateHub,ci=d.Action,li=d.ActionModifier,ai=li.Default,oi=li.Failed,vi=li.Succeeded,yi=ci.CreateDeploymentEnd,eu=ci.CreateDeploymentPreflight,ur=ci.CreateDeploymentStart,
fi=y.makeResourceManagerTelemetry,pi="Microsoft.Resources/deployments/write",ou={source:"Microsoft.Resources",operationNameRegex:pi};n.resourceGroupCheckDelay=1e3;n.resourceGroupCheckRetries=5;n.rpRegistrationCheckDelay=1e3;n.rpRegistrationCheckRetries=3;var ut="",su={optionsUndefined:ut,subscriptionIdUndefined:ut,resourceGroupNameUndefined:ut,resourceGroupLocationUndefined:ut,deploymentNameUndefined:ut,parametersLinkAndParameters:ut,duplicateKey:ut,templateLinkAndJson:ut,uriNotAString:ut,parsingTemplateJson:ut,invalidResourceId:ut,invalidResourceProviders:ut},w=r.getErrorMap(su);n.getDeepLinkToResourceGroup=gt;n.updateNotification=vt;n.getArmResource=ri;n.createResourceGroup=br;n.registerResourceProvider=tf;n.initialSetup=uf;n.sanityCheck=ff;n.provisionResourceGroup=ef;n.registerResourceProviders=of;n.getDeploymentName=sf;n.fulfillPrerequisites=hf;n.submitDeploymentRequest=cf;n.handleOverriddenDeployment=lf;n.getPollingInterval=af;n.checkDeploymentStatus=dr;n.pollForDeployment=vf;n.validateTemplate=
yf;n.startDeployment=pf})(et=t.Internal||(t.Internal={}))})(g||(g={})),g}))